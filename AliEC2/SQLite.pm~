package AliEC2::SQLite;

use strict;
use warnings;

use Dancer;
use DBI;
use Log::Log4perl qw< :easy >;

setting log4perl => {
   tiny => 0,
   config => '
      log4perl.logger                      = DEBUG, OnFile, OnScreen
      log4perl.appender.OnFile             = Log::Log4perl::Appender::File
      log4perl.appender.OnFile.filename    = sample-debug.log
      log4perl.appender.OnFile.mode        = append
      log4perl.appender.OnFile.layout      = Log::Log4perl::Layout::PatternLayout
      log4perl.appender.OnFile.layout.ConversionPattern = [%d] [%5p] %m%n
      log4perl.appender.OnScreen           = Log::Log4perl::Appender::ScreenColoredLevels
      log4perl.appender.OnScreen.color.ERROR = bold red
      log4perl.appender.OnScreen.color.FATAL = bold red
      log4perl.appender.OnScreen.color.OFF   = bold green
      log4perl.appender.OnScreen.Threshold = ERROR
      log4perl.appender.OnScreen.layout    = Log::Log4perl::Layout::PatternLayout
      log4perl.appender.OnScreen.layout.ConversionPattern = [%d] >>> %m%n
   ',
};
setting logger => 'log4perl';

=comment

Database
 + InstanceName Text
 + JobID Integer So we dont start multiple instances for one job
 + LastUpdate Timestamp
 + Status Text

=cut

use Exporter qw(import);
our @EXPORT_OK = qw(add delete exist setStatus getStatus);

my $dbh;

sub new {
    my ($class, %args) = @_;
    
    $dbh = DBI->connect("dbi:SQLite:dbname=aliec2db","","");
    $dbh->do("create table if not exists instances (
        InstanceName Text PRIMARY KEY,
        JobID Integer,
        Status Text,
        LastUpdate DATETIME DEFAULT CURRENT_TIMESTAMP
    );");
    
    return bless { %args }, $class;
};

sub add {
    my ($self, $id, $jobid) = @_;
    
    if($self->existVM($id)) {
        return "Instance exist";
    }
    
    if($self->existJobID($jobid)) {
        return "JobID exist";
    }
    
    if($dbh->do("insert into instances ('InstanceName', 'JobID', 'Status') values ('$id','$jobid','Spawned');")) {
        return "OK";
    }
    else {
        return "Error";
    }
};

sub delete {
    my ($self, $id) = @_;
    
    if($self->existVM($id)) {
        my $stmt = qq(delete from instances where InstanceName='$id');
        my $query = $dbh->prepare($stmt);
        my $rv = $query->execute();
        
        if($rv < 1) {
            return "An error occured: no rows deleted";
        }
        return "OK. Deleted";
    }
    return "No such instance";
};

sub existVM {
    my ($self, $id) = @_;
    
    my $stmt = qq(SELECT count(*) from instances where InstanceName='$id');
    my $query = $dbh->prepare($stmt);
    my $rv = $query->execute();
    my $rowcount = $query->fetchrow_array;
    
    if($rowcount == 0) {
        return 0;
    }
    
    return 1;
};

sub existJobID {
    my ($self, $id) = @_;
    
    my $stmt = qq(SELECT count(*) from instances where JobID='$id');
    my $query = $dbh->prepare($stmt);
    my $rv = $query->execute();
    my $rowcount = $query->fetchrow_array;
    
    if($rowcount == 0) {
        return 0;
    }
    
    return 1;
};

sub setStatus {
    my ($self, $id) = @_;
    
    if($self->existVM($id)) {
        my $stmt = qq(update instances set Status='Alive' where InstanceName='$id');
        my $query = $dbh->prepare($stmt);
        my $rv = $query->execute();
        
        if($rv < 1) {
            return "An error occured: no rows updated";
        }
        return "OK. Updated";
    }
    return "No such instance";
};

sub getStatus {
    my $id = @_;
};

sub end {
    $dbh->disconnect();
};

1;
